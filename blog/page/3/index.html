<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Blog | Felipe Martin</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for fmartingr.com" href="/feed.xml" />
    <link rel="icon" href="/static/images/favicon.ico">
    <!-- Mobile -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta http-equiv="cleartype" content="on">
    
    <script defer src="https://umami.fmartingr.dev/script.js" data-website-id="18da78a4-f6bd-4560-88fd-e28ca0b487fa"></script>
    
    
  </head>
  <body class="">
    <div class="page-content center">
      <header>
        <div class="avatar">
          <img class="avatar" src="/static/images/avatar.jpg?h=f834fb12">
        </div>
        <h1>Felipe Mart√≠n</h1>
        <nav>
          <a  href="/">/home</a>
          
            <a class="text-bold" href="/blog/">/blog</a>
          
            <a  href="/about/">/about</a>
          
        </nav>
      </header>
      <hr>
      <section class="main-content">
        
  
    
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2022/08/12/using-ssh-config-match-to-connect-to-a-host-using-multiple-ip-or-hostnames/">Using ssh_config Match to connect to a host using multiple IP or Hostnames</a></h1>
    <div class="info">
      Published on August 12, 2022
    </div>
    
      <div class="content">
        
        
          <p>My main computer is a MacBook Pro from 2017, but I have some servers laying around and one other laptop connected at home
with ArchLinux installed that I use mainly for development. I connect to it remotely either directly using a
SSH/Mosh + Tmux + Emacs/Vim combination, or using the pretty convenient VSCode Remote Extensions when I'm not feeling
much of a <em>hacker</em>.</p>
<p>Thing is, I may access this computer either from my home network directly if I'm at home or via a SDN if I am not (at the office,
coffeeshop, visiting family, etc).</p>
<p>My approach was to setup the hosts directly on my <code>~/.ssh/ssh_config</code> as you would with different machines:</p>
<div class="hll"><pre><span></span><span class="c1"># .ssh/config</span>
Host<span class="w"> </span>laptop.lan
<span class="w">    </span>HostName<span class="w"> </span><span class="m">192</span>.168.1.2<span class="w"> </span><span class="c1"># Internal network IP</span>

Host<span class="w"> </span>laptop.sdn
<span class="w">    </span>Hostname<span class="w"> </span><span class="m">10</span>.0.0.2<span class="w"> </span><span class="c1"># SDN IP</span>
</pre></div>
<p>That way, I would connect to each one of them depending on the situation. Using tmux and ssh is not that much of a problem
since I could just detach from home, go away, then connect via SDN an everything would be there (though I had to remember
which alias to use instead of just <code>ssh laptop</code>). For VSCode is not that convenient since I would need to close the connection,
made a new one to the new host and so on. Surely we could made this simpler, right?</p>
<p>In my home network, my main router is also my DNS server (with Ad Blocking, rules and all kind of fancy things), and that
server resolves my local domain (<code>*.lan</code>) to LAN IP Addresses, so I can start with a simple config as I had previously:</p>
<div class="hll"><pre><span></span><span class="c1"># .ssh/config</span>
Host<span class="w"> </span>laptop
<span class="w">    </span>HostName<span class="w"> </span>laptop.lan
</pre></div>
<p>Now, what happens if I'm not at home? I could solve this in several ways:</p>
<ul>
<li>I could <code>ping</code> my router, but that could collide with other networks out there.</li>
<li>I could check if my Wifi BSSID is one of the APs at home, but I could also connect via Ethernet.</li>
<li>I could check if I can resolve the <code>laptop.lan</code> address, though this requires network access, but in the end is the one I ended
up using.</li>
</ul>
<div class="hll"><pre><span></span>$<span class="w"> </span>dig<span class="w"> </span>+short<span class="w"> </span>laptop.lan
<span class="m">192</span>.168.1.2<span class="w"> </span><span class="c1"># At home</span>

$<span class="w"> </span>dig<span class="w"> </span>+short<span class="w"> </span>laptop.lan
<span class="c1"># Empty result when away from home</span>
</pre></div>
<p>Now, here comes the <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html"><code>Match</code></a> magic:</p>
<div class="hll"><pre><span></span><span class="c1"># .ssh/config</span>
Host<span class="w"> </span>laptop
<span class="w">    </span>HostName<span class="w"> </span>laptop.lan

Match<span class="w"> </span>originalhost<span class="w"> </span>laptop<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;[[ </span><span class="k">$(</span>/usr/bin/dig<span class="w"> </span>+short<span class="w"> </span>laptop.lan<span class="k">)</span><span class="s2"> == &#39;&#39; ]]&quot;</span>
<span class="w">    </span>HostName<span class="w"> </span>laptop.sdn
</pre></div>
<p>Using <code>Match</code> we can replace properties for a defined host using matches. In this ad-hoc example what I did is:</p>
<ul>
<li><code>Match originalhost laptop</code>: The connection host need to match <code>laptop</code></li>
<li><code>exec "[[ $(/usr/bin/dig +short laptop.lan) == '' ]]"</code>: Execute <code>dig</code> and try to resolve my LAN's laptop domain name.
This needs to be a successful command for it to match, in this case we compare <code>dig</code>s output to an empty string to evaluate
if we can resolve the <code>laptop.lan</code> domain name (check the <code>[[ ]]</code>).</li>
<li><code>HostName laptop.sdn</code> If both rules match, replace the <code>HostName</code> property with the laptop's SDN domain name.</li>
</ul>
<p>This is a pretty easy way to just <code>ssh laptop</code> wherever I am. I didn't knew about this particular
keyword until today, and it's pretty powerful!</p>
<p>Documentation: <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html">ssh_config(5) manpage</a></p>

        
      </div>
    
    <hr />
  </article>

  
    
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2022/05/04/april-2022/">April 2022</a></h1>
    <div class="info">
      Published on May 04, 2022
    </div>
    
      <div class="content">
        
        
          <p><img src="/blog/2022/05/04/april-2022/image-640.png" alt="A picture of a room in my house right now, full of boxes because we&#39;re moving to a new flat."></p>
<p>This is the most accurate summary I can give of the last month. This is the first time player 2 and I are moving between
places together, and between the usual work this kind of thing has and some surprises we have had along the way... I didn't
have time for anything else.</p>
<p>TV has been set in the living room for... three days? And we haven't used it. I can play a little bit on the Deck when tired,
but usually no more than 20 minutes or so. Reading is limited to that little time before going to sleep, and we've been
so tired that I'm lucky if I manage to finish one chapter.</p>
<p>I started to catch up with Github and E-Mail yesterday (literally!), hopefully things will normalize in June.</p>

        
      </div>
    
    <hr />
  </article>

  
    
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2022/04/01/march-2022/">March 2022</a></h1>
    <div class="info">
      Published on April 01, 2022
    </div>
    
      <div class="content">
        
        
          <p><img src="/blog/2022/04/01/march-2022/image-360.jpg" alt="A Japanese Torii gate"></p>
<div class="text-center">I've started drawing a little on the tablet. I'm awful at it, but it's a relaxing way to pass the time while having a cup of coffee. (Yes, the date is wrong)</div>
          <p class="text-right"><a href="/blog/2022/04/01/march-2022/">Read more &raquo;</a></p>
        
      </div>
    
    <hr />
  </article>

  
    
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2022/03/01/february-2022/">February 2022</a></h1>
    <div class="info">
      Published on March 01, 2022
    </div>
    
      <div class="content">
        
        
          <p><img src="/blog/2022/03/01/february-2022/image-360.png" alt="Me sitting on the couch with my laptop, with a couch laptop table on top of my arms while triaging all shiori issues."></p>
<div class="text-center">I'm pretty sure this is how everyone use their laptops at home.</div>
          <p class="text-right"><a href="/blog/2022/03/01/february-2022/">Read more &raquo;</a></p>
        
      </div>
    
    <hr />
  </article>

  
    
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2022/02/01/january-2022/">January 2022</a></h1>
    <div class="info">
      Published on February 01, 2022
    </div>
    
      <div class="content">
        
        
          <p><img src="/blog/2022/02/01/january-2022/image-360.jpg" alt="A picture of me resting a book called Press Reset on my legs while looking at the horizon."></p>
<div class="text-center">We had amazing holidays this year.</div>
          <p class="text-right"><a href="/blog/2022/02/01/january-2022/">Read more &raquo;</a></p>
        
      </div>
    
    <hr />
  </article>

  

  <div>
  <div class="pagination">
    <div class="float-left">
      
        <a href="/blog/page/2/">&laquo; Newer</a>
      
    </div>
    <div class="float-right">
      
        <a href="/blog/page/4/">Older &raquo;</a>
      
    </div>
    <div class="text-center">Page 3</div>
    <div class="clearfloat"></div>
  </div>
</div>

      </section>
      <hr>
      <footer>
        <div>My opinions are my own.</div>
        <div>Created using <a target="_blank" href="https://getlektor.com">Lektor</a> | <a target="_blank" href="https://github.com/fmartingr/fmartingr.com">Source code</a> | <a href="/feed.xml">RSS Feed</a> | <a target="_blank" href="/about">About me</a></div>
      </footer>
    
  

  </body>
</html>
