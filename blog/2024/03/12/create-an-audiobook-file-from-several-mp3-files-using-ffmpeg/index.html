<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Create an audiobook file from several mp3 files using ffmpeg | Blog | Felipe Martin</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for fmartingr.com" href="/feed.xml" />
    <link rel="icon" href="/static/images/favicon.ico">
    <!-- Mobile -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta http-equiv="cleartype" content="on">
    
    <script defer src="https://umami.fmartingr.dev/script.js" data-website-id="18da78a4-f6bd-4560-88fd-e28ca0b487fa"></script>
    
    
  </head>
  <body class="blog post">
    <div class="page-content center">
      <header>
        <div class="avatar">
          <img class="avatar" src="/static/images/avatar.jpg?h=f834fb12">
        </div>
        <h1>Felipe Mart√≠n</h1>
        <nav>
          <a  href="/">/home</a>
          
            <a class="text-bold" href="/blog/">/blog</a>
          
            <a  href="/about/">/about</a>
          
        </nav>
      </header>
      <hr>
      <section class="main-content">
        
  
  
  <article class="blog-post">
    <h1 class="title"><a href="/blog/2024/03/12/create-an-audiobook-file-from-several-mp3-files-using-ffmpeg/">Create an audiobook file from several mp3 files using ffmpeg</a></h1>
    <div class="info">
      Published on March 12, 2024
    </div>
    
      <div class="content">
        
        
          <p>Due to some recent traveling I have started to listen to audiobooks. I love reading but some times my eyes are just too tired to go with it but I'm not sleepy at all or maybe I just wanted the convenience to lay down but still <em>do</em> something.</p>
<p>Short story, I bought some from a known distributor but I'm a fan of data preservation and actually owning what I pay for. I found an application in Github that allowed me to download the files that composed the audiobook in split mp3 files, but that didn't do. I wanted a single file with correct metadata, so I got my hands dirty.</p>
<p><img src="/blog/2024/03/12/create-an-audiobook-file-from-several-mp3-files-using-ffmpeg/book_player_screenshot-360.jpeg" alt=""></p>
<!-- readmore -->

<p>Assuming you have the mp3 laying around in a folder, we need to generate or find three more things:</p>
<ul>
<li><p><strong><code>files.txt</code></strong>: A list of the MP3 files in the order we are going to combine them, in a plain text file with the format <code>file '&lt;filename&gt;'</code>.</p>
<p>You can use a simple bash command to generate the file:</p>
<div class="hll"><pre><span></span>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*mp3&quot;</span><span class="w"> </span>-exec<span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;file &#39;%s&#39;\n&quot;</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s2">&quot;s|\.\/||g&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>files.txt
</pre></div>
</li>
<li><p><strong><code>metadata.txt</code></strong>: A metadata file to be used with the bundled file that contain basic information of the audiobook (title, author, narrator, ...) along with chapter information.</p>
<p>An example looks like this, documentation can be found <a href="https://ffmpeg.org/ffmpeg-formats.html#Metadata-1">in the ffmpeg documentation</a>:</p>
<div class="hll"><pre><span></span><span class="c1">;FFMETADATA1</span>
<span class="na">title</span><span class="o">=</span><span class="s">Book name</span>
<span class="na">artist</span><span class="o">=</span><span class="s">Book author(s)</span>
<span class="na">composer</span><span class="o">=</span><span class="s">Book narrator(s)</span>
<span class="na">publisher</span><span class="o">=</span><span class="s">Book publisher</span>
<span class="na">date</span><span class="o">=</span><span class="s">Book date of publication</span>

<span class="k">[CHAPTER]</span>
<span class="na">TIMEBASE</span><span class="o">=</span><span class="s">1/1000</span>
<span class="na">START</span><span class="o">=</span><span class="s">0</span><span class="w"> </span><span class="c1"># 0:00:00</span>
<span class="na">END</span><span class="o">=</span><span class="s">60000</span><span class="w"> </span><span class="c1"># 0:01:00</span>
<span class="na">title</span><span class="o">=</span><span class="s">Intro</span><span class="w"> </span><span class="c1"># Chapter title</span>

<span class="c1"># Repeat the [CHAPTER] block for all chapters</span>
</pre></div>
</li>
<li><p><strong><code>cover.jpg</code></strong>: The artwork of the audiobook. The files I have been using (downloaded from the store) are 353x353@72dpi. I'm unsure if that's by definition, but at least be sure to use squared images.</p>
</li>
</ul>
<p>With all the files in place, we can use <code>ffmpeg</code> to do the conversion. I have followed a multi step approach to make sure I can review the process and fix any issues that may arise. Pretty sure this can be simplified somehow but I'm not a <code>ffmpeg</code> expert and I have spent too much time on this already.</p>
<ol>
<li><p>Concatenate the files into a single <code>mp3</code> file.</p>
<div class="hll"><pre><span></span>ffmpeg<span class="w"> </span>-f<span class="w"> </span>concat<span class="w"> </span>-i<span class="w"> </span>files.txt<span class="w"> </span>-c<span class="w"> </span>copy<span class="w"> </span>build_01_concat.mp3
</pre></div>
<ul>
<li><code>-f concat</code>: Use the <code>concat</code> format, meaning we are going to concatenate files.</li>
<li><code>-i files.txt</code>: The file with the list of files to concatenate as input to ffmpeg.</li>
<li><code>-c copy</code>: The stream copy codec for each stream, meaning we are not going to re-encode the files, just copy them.</li>
<li><code>build_01_concat.mp3</code>: The output file.</li>
</ul>
</li>
<li><p>Add the cover to the file.</p>
<div class="hll"><pre><span></span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>build_01_concat.mp3<span class="w"> </span>-i<span class="w"> </span>cover.jpg<span class="w"> </span>-c<span class="w"> </span>copy<span class="w"> </span>-map<span class="w"> </span><span class="m">0</span><span class="w"> </span>-map<span class="w"> </span><span class="m">1</span><span class="w"> </span>build_02_cover.mp3
</pre></div>
<ul>
<li><code>-i build_01_concat.mp3</code>: The file created in the above step to be used as input to ffmpeg.</li>
<li><code>-i cover.jpg</code>: The cover image to be added to the file as second input to ffmpeg.</li>
<li><code>-c copy</code>: The stream copy codec for each stream, meaning we are not going to re-encode the files, just copy them.</li>
<li><code>-map 0 -map 1</code>: Maps the streams from the input files to the output file.</li>
<li><code>build_02_cover.mp3</code>: The output file.</li>
</ul>
</li>
<li><p>Convert the <code>mp3</code> file to <code>m4a</code>.</p>
<div class="hll"><pre><span></span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>build_02_cover.mp3<span class="w"> </span>-c:v<span class="w"> </span>copy<span class="w"> </span>build_03_m4a.m4a
</pre></div>
<ul>
<li><code>-i build_02_cover.mp3</code>: The file created in the above step to be used as input to ffmpeg.</li>
<li><code>-c:v copy</code>: The video codec to be used for the output file, meaning we are not going to re-encode the file, just copy it.</li>
<li><code>build_03_m4a.m4a</code>: The output file.</li>
</ul>
</li>
<li><p>Add the metadata to the <code>m4a</code> file and convert it to <code>m4b</code>.</p>
<div class="hll"><pre><span></span>ffmpeg<span class="w"> </span>-i<span class="w"> </span>build_03_m4a.m4a<span class="w"> </span>-i<span class="w"> </span>metadata.txt<span class="w"> </span>-map<span class="w"> </span><span class="m">0</span><span class="w"> </span>-map_metadata<span class="w"> </span><span class="m">1</span><span class="w"> </span>-c<span class="w"> </span>copy<span class="w"> </span>book.m4b
</pre></div>
<ul>
<li><code>-i build_03_m4a.m4a</code>: The file created in the above step to be used as input to ffmpeg.</li>
<li><code>-i metadata.txt</code>: The metadata file to be used as second input to ffmpeg.</li>
<li><code>-map 0 -map_metadata 1</code>: Maps the streams from the input files to the output file.</li>
<li><code>-c copy</code>: The stream copy codec for each stream, meaning we are not going to re-encode the files, just copy them.</li>
<li><code>book.m4b</code>: The final output file.</li>
</ul>
</li>
<li><p>Clean up the files we created in the process that we don't need anymore.</p>
<div class="hll"><pre><span></span>rm<span class="w"> </span>build_*<span class="w"> </span>files.txt
</pre></div>
</li>
</ol>
<p>That's it! You should have a <code>m4b</code> file with the audiobook ready to be imported to your favorite audiobook player. I have tested this process with a couple of books and it worked like a charm. I hope it helps you too.</p>

        
      </div>
    
    <hr />
  </article>

  <div class="block-info">
    If you want to approach me directly about this post use the most appropriate channel 
    from <a href="/about/">the about page</a>.
  </div>

      </section>
      <hr>
      <footer>
        <div>My opinions are my own.</div>
        <div>Created using <a target="_blank" href="https://getlektor.com">Lektor</a> | <a target="_blank" href="https://github.com/fmartingr/fmartingr.com">Source code</a> | <a href="/feed.xml">RSS Feed</a> | <a target="_blank" href="/about">About me</a></div>
      </footer>
    
  

  </body>
</html>
